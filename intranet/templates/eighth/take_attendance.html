{% extends "page_with_nav.html" %}
{% load staticfiles %}

{% block title %}
    {{ block.super }}{% if request.user.is_eighth_admin %} - Eighth Admin{% endif %} - {% if scheduled_activity.locked %}Take Attendance{% else %}View Roster{% endif %}
{% endblock %}

{% block css %}
    <link rel="stylesheet" type="text/css" href="{% static 'vendor/selectize.js-0.12.0/dist/css/selectize.default.css' %}">
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{% static 'css/eighth.common.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/eighth.attendance.css' %}" />
{% endblock %}

{% block js %}
    {{ block.super }}
    <script type="text/javascript" src="{% static 'vendor/selectize.js-0.12.0/dist/js/standalone/selectize.min.js' %}"></script>
    <!--[if lt IE 9]><script src="http://cdnjs.cloudflare.com/ajax/libs/es5-shim/2.0.8/es5-shim.min.js"></script><![endif]-->
    <script type="text/javascript" src="{% static 'js/eighth/attendance.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/eighth/ui_init.js' %}"></script>
{% endblock %}


{% block main %}
    <div class="primary-content">
        <div class="eighth-header">
                <h2>
                    {% if scheduled_activity.locked %}
                        Take Attendance
                    {% else %}
                        View Roster
                    {% endif %}
                </h2>

                {% if request.user.is_eighth_admin %}
                    {% include "eighth/admin/start_date.html" %}
                {% endif %}
        </div>

        {% if request.GET.ns %}
            <strong>You are not sponsoring any activities. You are not an eighth period sponsor.</strong>
            <br />
        {% endif %}

        {% if request.GET.na %}
            <strong>You are not sponsoring any activities for the block you selected.</strong>
            <br />
        {% endif %}

        {% if wizard %}
            <form action="" method="post">
                {% csrf_token %}
                {{ wizard.management_form }}
                {{ wizard.form }}
                {% if wizard.steps.prev %}
                    <button name="wizard_goto_step" type="submit" value="{{ wizard.steps.prev }}">Back</button>
                {% endif %}
                {% if wizard.steps.next %}
                    <input type="submit" value="Next"/>
                {% else %}
                    <input type="submit" value="Take Attendance"/>
                {% endif %}
            </form>
        {% else %}
            <div class="attendance-container">
                <table class="key-value-table activity-attributes">
                    <tr>
                        <th>Activity:</th>
                        <td>{{ scheduled_activity.activity.name_with_flags }} ({{ scheduled_activity.activity.id }})</td>
                    </tr>
                    <tr>
                        <th>Date:</th>
                        <td>{{ scheduled_activity.block.date|date:"EIGHTH_BLOCK_DATE_FORMAT" }}, {{ scheduled_activity.block.block_letter }} Block</td>
                    </tr>
                    <tr>
                        <th>Rooms:</th>
                        <td>{{ scheduled_activity.get_true_rooms|join:", " }}</td>
                    </tr>
                    <tr>
                        <th>Sponsors:</th>
                        <td>{{ scheduled_activity.get_true_sponsors|join:", " }}</td>
                    </tr>
                    <tr>
                        <th>Signups:</th>
                        {% with scheduled_activity.get_true_capacity as capacity %}
                            <td>{{ members|length }}/{% if capacity == -1%}Unlimited{% else %}{{ capacity }}{% endif %} </td>
                        {% endwith %}
                    </tr>
                </table>


                {% if scheduled_activity.attendance_taken %}
                    <div class="attendance-taken">
                        <i class="fa fa-check"></i> Attendance Taken
                    </div>
                {% elif scheduled_activity.locked %}
                    <div class="no-attendance">
                        <i class="fa fa-exclamation-triangle"></i> Attendance Not Taken
                    </div>
                {% endif %}
                {% if passes %}
                    <h3>Passes</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pass in passes %}
                                <tr>
                                    <td>
                                        {{ pass.user.last_name }}, {{ pass.user.first_name }} ({{ pass.user.id }})
                                    </td>
                                    <td>
                                        <form id="pass-form-{{ pass.id }}" action="{% url 'eighth_accept_pass' pass.id %}" method="post">
                                            {% csrf_token %}
                                            <a href="#" onclick="return false" class="pass-form-submit-link" data-form="pass-form-{{ pass.id }}">Accept</a>
                                        </form>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <form action="{% url 'eighth_accept_all_passes' scheduled_activity.id %}" method="post">
                        {% csrf_token %}
                        <input type="submit" class="button accept-all-passes" value="Accept All">
                    </form>
                {% endif %}

                <form class="attendance-form" action="" method="post">
                    {% csrf_token %}
                    <table class="take-attendance-roster">
                        <thead>
                            <tr>
                                {% if scheduled_activity.locked %}
                                    <th><input type="checkbox" class="">Present</th>
                                {% endif %}
                                <th>Student</th>
                                <th>Grade</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for member in members %}
                                <tr>
                                    {% if scheduled_activity.locked %}
                                        <td class="present-checkbox"><input type="checkbox" name="{{ member.id }}"{% if member.present %} checked{% endif %}></td>
                                    {% endif %}
                                    <td>{{ member.name }}</td>
                                    <td>{{ member.grade }}</td>
                                    <td>{% if member.had_pass %}(Pass Accepted){% endif %}</td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="4">
                                        There are no students signed up.
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% if not scheduled_activity.locked %}
                        <br />
                        <br />
                        <b>You may not take attendance for this activity - signups are not yet locked.</b>
                        <br />
                    {% else %}
                        <input type="submit" class="save-button" value="{% if scheduled_activity.attendance_taken %}Update{% else %}Take{% endif %} Attendance">
                    {% endif %}
                </form>
            </div>
        {% endif %}
    </div>
{% endblock %}
