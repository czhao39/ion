{% extends "eighth/admin/eighth_admin_page_base.html" %}
{% load staticfiles %}

{% block css %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{% static 'css/eighth.schedule.css' %}" />
{% endblock %}

{% block js %}
    {{ block.super }}
    <script type="text/javascript">
$(function() {
    $(".select-all").change(function() {
        var chk = $(this).prop("checked");
        var name = $(this).attr("data-name");
        console.debug(chk, name);
        $(".user-item").each(function() {
            if($(this).attr("name") == name) {
                $(this).prop("checked", chk);
            }
        });
    });

    $(".user-item").change(function() {
        var chk = $(this).prop("checked");
        var name = $(this).attr("name");
        var num_checked = 0;
        $(".user-item").each(function() {
            if($(this).prop("checked")) {
                num_checked++;
            }
        });
        $e = $(".select-all[data-name='"+ name + "']");
        if(num_checked == 0) {
            $e.prop("checked", false);
            $e.prop("indeterminate", false);
        } else if(num_checked == $(".user-item").length) {
            $e.prop("checked", true);
            $e.prop("indeterminate", false);
        } else {
            $e.prop("checked", false);
            $e.prop("indeterminate", true);
        }
    });

})
    </script>
{% endblock %}

{% block admin_main %}
    {% if show_selection %}
    <form action="{% url 'eighth_admin_distribute_action' %}" method="post">
        
        {% if users_type == "unsigned" %}
            <p>These users have not signed up for any activities.</p>
        {% elif users_type == "group" %}
            <b>Group:</b> {{ group }}<br />
            <a href="{% url 'eighth_admin_edit_group' group.id %}" class="button">Modify Group</a>
        {% endif %}
        <input type="hidden" name="users" value="true" />
        {% csrf_token %}
        <table class="distribute-group-grid fancy-table">
            <thead>
                <tr>
                    <th>User</th>
                    {% for sch in schacts %}
                    <th>
                        {{ sch.activity }}<br />
                        {{ sch.block }}<br />
                        <input type="checkbox" name="select-all-{{ sch.id }}" class="select-all" data-name="schact{{ sch.id }}" />
                    </th>
                    {% empty %}
                    <th>No activities found.</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.display_name }} ({{ user }})</td>
                {% for sch in schacts %}
                <td>
                    <input type="checkbox" class="user-item" name="schact{{ sch.id }}" value="{{ user.id }}" />
                </td>
                {% endfor %}
            </tr>
            {% empty %}
                <td>No users found.</td>
            {% endfor %}
            </tbody>
        </table>

        <input type="submit" value="Finish" />
    {% else %}
    <form method="post">{% csrf_token %}
        {{ wizard.management_form }}
        <p>Step {{ wizard.steps.step1 }} of {{ wizard.steps.count }}</p>
        <br>
        {{ wizard.form }}
        {% if wizard.steps.prev %}
            <button name="wizard_goto_step" type="submit" value="{{ wizard.steps.prev }}">Previous Step</button>
        {% endif %}
        {% if wizard.steps.next %}
            <input type="submit" value="Next"/>
        {% else %}
            <input type="submit" value="Distribute Group"/>
        {% endif %}
    {% endif %}
    </form>
{% endblock %}
