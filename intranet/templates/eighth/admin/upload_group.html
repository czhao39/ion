{% extends "eighth/admin/eighth_admin_page_base.html" %}
{% load staticfiles %}

{% block js %}
    <script type="text/javascript" src="{% static 'vendor/sortable-0.6.0/js/sortable.min.js' %}"></script>
    {{ block.super }}
    <script type="text/javascript">
        $(function() {
            Sortable.init();
        });
    </script>
{% endblock %}

{% block css %}
    <link rel="stylesheet" type="text/css" href="{% static 'vendor/sortable-0.6.0/css/sortable-theme-minimal.css' %}">
    {{ block.super }}
    <style type="text/css">
textarea[name=filetext] {
    width: 500px;
    height: 200px;
}
    </style>
{% endblock %}

{% block admin_main %}

{% if stage == "upload" %}
    <p style="width: 500px">Either upload a file or enter text in the box below containing either Student IDs (e.x. 1231234), Ion IDs (31863), or TJ usernames (2016jwoglom), separated by line breaks.</p>
    <form action="" method="post" autocomplete="off" enctype="multipart/form-data">
        {% csrf_token %}
        <label for="file"><b>Upload File:</b></label>
        <br /><br />
        {{ form.file }}
        <br /><br />
        <input type="submit" value="Upload" />
    </form>
    <br />
    <hr />
    <br />
    <form action="" method="post" autocomplete="off" enctype="multipart/form-data">
        {% csrf_token %}
        <label for="filetext"><b>Enter text:</b></label><br />
        <textarea name="filetext"></textarea>
        <br />
        <input type="submit" value="Read Data" />
    </form>

{% elif stage == "parse" %}
    <h3>There {% if sure_users|length == 1 %}was {{ sure_users|length }} user{% else %}were {{ sure_users|length }} users{% endif %} matched:</h3>
    Check the boxes for the users you wish to import. Click on column titles to sort.
    <form action="" method="post">
    {% csrf_token %}
    <table data-sortable class="fancy-table">
    <thead>
        <tr>
            <th>Input line</th>
            <th></th>
            <th>User Matched</th>
        </tr>
    </thead>
    <tbody>
    {% for user in sure_users %}
        <tr>
            <td>{{ user.0 }}</td>
            <td>
                <input type="checkbox" name="user_id" value="{{ user.1.id }}" checked /> 
            </td>
            <td>
                {% if user.1.display_name %}{{ user.1.display_name }}{% else %}{{ user.1.full_name }}{% endif %} ({{ user.1.student_id }}{% if user.1.grade.number %}, {{ user.1.grade.number }}{% elif user.1.is_teacher %}, Staff{% endif %})
            </td>
        </tr>
    {% empty %}
        No valid user identifiers were found.
    {% endfor %}
    </tbody>
    </table>
    <input type="submit" value="Add Users" />
    <br /><br />
    <h3>There {% if unsure_users|length == 1 %}was {{ unsure_users|length }} user{% else %}were {{ unsure_users|length }} users{% endif %} not matched:</h3>
    Click on column titles to sort.
    <table data-sortable class="fancy-table">
    <thead>
        <tr>
            <th>Input line</th>
            <th></th>
            <th>User Matched</th>
        </tr>
    </thead>
    <tbody>
    {% for user in unsure_users %}
        <tr>
            <th>{{ user.0 }}</th>
            {% if user.1 %}
                {% for u in user.1 %}
                <td>
                    <input type="checkbox" name="add_user" value="{{ u.id }}" /> 
                </td>
                <td>
                    {{ u.display_name }} ({{ u.student_id }}, {{ u.grade }})
                </td>
                {% endfor %}
            {% else %}
                <td></td>
                <td>No unique matches found.</td>
            {% endif %}
            </td>
        </tr>
    {% empty %}
        <tr>
            <th colspan="3">All users were properly matched.</th>
        </tr>
    {% endfor %}
    </tbody>
    </table>
    </form>
{% endif %}

{% endblock %}
